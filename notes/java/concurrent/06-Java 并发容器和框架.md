# Java 并发容器和框架

---

## 1. ConcurrentHashMap 的实现原理与使用

`ConcurrentHashMap` 是由 `Segment` 数组结构和 `HashEntry` 数组结构组成。`Segment` 是一种可重入 (ReentrantLock)，在 `ConcurrentHashMap` 里扮演锁的角色；`HashEntry` 则用于存储键值对数据。一个`ConcurrentHashMap` 里包含一个 `Segment` 数组。`Segment` 的结构和 `HashMap` 类似，是一种数组和链表结构。一个 `Segment` 里包含一个 `HashEntry` 数组，每个 `HashEntry` 是一个链表结构的元 素，每个 `Segment` 守护着一个 `HashEntry` 数组里的元素，当对 `HashEntry` 数组的数据进行修改时， 必须首先获得与它对应的`Segment` 锁。

ConcurrentHashMap 的 `get()` 方法里将要使用的共享变量都定义成 `volatile` 

## 2. ConcurrentLinkedQueue

ConcurrentLinkedQueue 是一个基于链接节点的无界线程安全队列，它采用先进先出的规则对节点进行排序，当我们添加一个元素的时候，它会添加到队列的尾部；当我们获取一个元素时，它会返回队列头部的元素。

它采用了“wait-free”算法(即 CAS 算法)来实现。

### 入队列

入队列就是将入队节点添加到队列的尾部。

## 3. Java 中的阻塞队列

**阻塞队列** (BlockingQueue) 是一个支持两个附加操作的队列。这两个附加的操作支持阻塞的插入和移除方法。

1) 支持阻塞的插入方法：意思是当队列满时，队列会阻塞插入元素的线程，直到队列不满。

2) 支持阻塞的移除方法：意思是在队列为空时，获取元素的线程会等待队列变为非空。

| 方法     | 抛出异常  | 返回特殊值 | 一直阻塞 | 超时退出             |
| -------- | --------- | ---------- | -------- | -------------------- |
| 插入方法 | add(e)    | offer(e)   | put(e)   | offer(e, time, unit) |
| 移除方法 | remove()  | poll()     | take()   | poll(time, unit)     |
| 检查方法 | element() | peek()     | 不可用   | 不可用               |

+ 抛出异常：当队列满时，如果再往队列里插入元素，会抛出 `IllegalStateException("Queue full")` 异常。当队列空时，从队列里获取元素会抛出 `NoSuchElementException` 异常。
+ 返回特殊值：当往队列插入元素时，会返回元素是否插入成功，成功返回 true。如果是移除方法，则是从队列里取出一个元素，如果没有则返回 null。
+ 一直阻塞：当阻塞队列满时，如果生产者线程往队列里 `put` 元素，队列会一直阻塞生产者线程，直到队列可用或者响应中断退出。当队列空时，如果消费者线程从队列里 `take` 元素，队列会阻塞住消费者线程，直到队列不为空。
+ 超时退出：当阻塞队列满时，如果生产者线程往队列里插入元素，队列会阻塞生产者线程一段时间，如果超过了指定的时间，生产者线程就会退出。

### Java 里的阻塞队列：

+ `ArrayBlockingQueue`：一个由数组结构组成的有界阻塞队列。

  默认情况下不保证线程公平的访问队列。 

+ `LinkedBlockingQueue`：一个由链表结构组成的有界阻塞队列。 

+ `PriorityBlockingQueue`：一个支持优先级排序的无界阻塞队列。 

  默认情况下元素采取**自然顺序升序**排列。也可以自定义类实现 `compareTo()` 方法来指定元素排序规则，或者初始化 PriorityBlockingQueue 时，指定构造参数 Comparator 来对元素进行排序。需要注意的是不能保证同优先级元素的顺序。

+ `DelayQueue`：一个使用优先级队列实现的无界阻塞队列。 

  支持延时获取元素，在创建元素时可以指定多久才能从队列中获取当前元素。 只有在延迟期满时才能从队列中提取元素。

+ `SynchronousQueue`：一个不存储元素的阻塞队列。 

  每一个 put 操作必须等待一个 take 操作， 否则不能继续添加元素。

+ `LinkedTransferQueue`：一个由链表结构组成的无界阻塞队列。 

+ `LinkedBlockingDeque`：一个由链表结构组成的双向阻塞队列。

  可以从队列的两端插入和移出元素

## 4. Fork/Join 框架

Fork/Join 框架是 Java 7 提供的一个用于并行执行任务的框架，是一个把大任务分割成若干个小任务，最终汇总每个小任务结果后得到大任务结果的框架。

### 工作窃取算法

工作窃取 (work-stealing) 算法是指某个线程从其他队列里窃取任务来执行。

为了减少窃取任务线程和被窃取任务线程之间的竞争，通常会使用双端队列，被窃取任务线程永远从双端队列的头部拿任务执行，而窃取任务的线程永远从双端队列的尾部拿任务执行。

**优点**：充分利用线程进行并行计算，减少了线程间的竞争。

**缺点**：在某些情况下还是存在竞争，比如双端队列里只有一个任务时。并且该算法会消耗了更多的系统资源，比如创建多个线程和多个双端队列。

